R.002848

----------

Name: GHW - Notices
Created by: George H Williams

----------

Group: Administrative Reports
     Testing

Created on: 2016-12-08 09:49:58
Modified on: 2016-12-08 09:49:58
Date last run: 2017-06-23 10:36:46

----------

Public: 0
Expiry: 300

----------



----------

SELECT
  Coalesce(branches.branchcode, 0) AS MASTER,
  Query2.branchcode,
  Query2.categorycode,
  Query2.code,
  Query2.letter_number,
  Query2.delay,
  Query2.letter_code,
  Query2.debarred,
  Query2.bcode,
  Query2.content,
  branches.branchcode AS branchcode1
FROM
  branches LEFT JOIN
  (SELECT
    odr.letter_number,
    odr.branchcode,
    odr.categorycode,
    odr.delay,
    odr.letter_code,
    odr.debarred,
    lettercontent.code,
    lettercontent.bcode,
    lettercontent.content
  FROM
    (SELECT
      '1' AS letter_number,
      overduerules.branchcode,
      overduerules.categorycode,
      overduerules.delay1 AS delay,
      overduerules.letter1 AS letter_code,
      overduerules.debarred1 AS debarred
    FROM
      overduerules
    UNION
    SELECT
      '2' AS letter_number,
      overduerules.branchcode,
      overduerules.categorycode,
      overduerules.delay2 AS delay,
      overduerules.letter2 AS letter_code,
      overduerules.debarred2 AS debarred
    FROM
      overduerules
    UNION
    SELECT
      '3' AS letter_number,
      overduerules.branchcode,
      overduerules.categorycode,
      overduerules.delay3 AS delay,
      overduerules.letter3 AS letter_code,
      overduerules.debarred3 AS debarred
    FROM
      overduerules) AS odr LEFT JOIN
    (SELECT
      letter.code,
      If(letter.branchcode = ' ', 'default', letter.branchcode) AS bcode,
      letter.content
    FROM
      letter) lettercontent
      ON odr.letter_code = lettercontent.code
  WHERE
    lettercontent.bcode = (If(lettercontent.bcode = odr.branchcode,
    odr.branchcode, 'default'))
  GROUP BY
    odr.letter_number, odr.branchcode, odr.categorycode, odr.delay,
    odr.letter_code, odr.debarred, lettercontent.code, lettercontent.bcode,
    lettercontent.content) Query2
    ON branches.branchcode = Query2.branchcode
GROUP BY
  Coalesce(branches.branchcode, 0), Query2.branchcode, Query2.code,
  Query2.letter_number, Query2.delay, Query2.letter_code, Query2.debarred,
  Query2.bcode, Query2.content, branches.branchcode
ORDER BY
  MASTER,
  Query2.letter_number



