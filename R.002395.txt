R.002395

----------

Name: Possible Patrons to Purge at Leavenworth
Created by: Heather Braum

----------

Group: Library-Specific
     Leavenworth

Created on: 2014-10-23 18:26:10
Modified on: 2015-04-14 16:36:08
Date last run: -

----------

Public: 0
Expiry: 0

----------

Gives borrowers at Leavenworth with just fines still owed (or no fines) and no checkouts, who have been expired since a specified date and where all fines were added after the library came into NExpress (9/1/10, because older "fines" are actually lost item charges). These are possible patrons to purge {for Leavenworth}. The companion report for all other libraries is #2489.

----------

SELECT b.borrowernumber as "borrower", CONCAT ('<a href=\"/cgi-bin/koha/members/boraccount.pl?borrowernumber=',b.borrowernumber,'\" target="_blank">',b.cardnumber,'</a>') AS "Link to Fines", FORMAT(sum(a.amountoutstanding), 2) as "owed" 
FROM borrowers b LEFT JOIN accountlines a USING(borrowernumber) 
WHERE b.dateexpiry < <<enter date in yyyy-mm-dd format for latest expiration date>> AND b.branchcode='LEAVENWRTH' AND (b.borrowernumber NOT IN 
(SELECT b.borrowernumber FROM accountlines a LEFT JOIN borrowers b USING(borrowernumber) WHERE b.branchcode='LEAVENWRTH' AND a.accounttype IN ('L','LOSTI','Damag','A','Copie','M','N') AND a.amountoutstanding > '0') 
OR b.borrowernumber NOT IN (SELECT borrowernumber FROM accountlines))  
AND b.borrowernumber NOT IN (SELECT borrowernumber FROM issues) 
AND a.date > '2010-09-01' 
GROUP BY b.borrowernumber HAVING sum(a.amountoutstanding) >= '0'
UNION ALL
SELECT b.borrowernumber as "borrower", CONCAT ('<a href=\"/cgi-bin/koha/members/boraccount.pl?borrowernumber=',b.borrowernumber,'\" target="_blank">',b.cardnumber,'</a>') AS "Link to Fines",  '0.00' as "owed" 
FROM borrowers b WHERE b.branchcode='LEAVENWRTH' AND b.dateexpiry < <<enter date in yyyy-mm-dd format for latest expiration date>> AND b.borrowernumber NOT IN 
(SELECT borrowernumber FROM issues) 
AND borrowernumber NOT IN (SELECT borrowernumber FROM accountlines)
ORDER BY CAST(owed AS DECIMAL(10,2)) DESC



