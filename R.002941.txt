R.002941

----------

Name: GHW - Patron purge 002
Created by: George H Williams

----------

Group: Patrons
     -

Created on: 2017-05-04 14:42:50
Modified on: 2017-05-04 16:58:19
Date last run: 2018-11-05 22:49:09

----------

Public: 0
Expiry: 0

----------



----------

SELECT
  borrowers.borrowernumber,
  UPPER(borrowers.cardnumber) AS CARD_NUMBER,
  borrowers.branchcode,
  borrowers.categorycode,
  borrowers.dateenrolled,
  borrowers.dateexpiry,
  Count(issues.issue_id) AS CURRENT_CKO_COUNT,
  Count(reserves.reserve_id) AS CURRENT_REQUEST_COUNT,
  Coalesce(guarantor.Count_borrowernumber, 0) AS GUARANTEE_COUNT,
  FORMAT(Coalesce(totalfees.Sum_amountoutstanding, 0), 2) AS TOTAL_FEES,
  Format(Coalesce(latefees.Sum_amountoutstanding, 0), 2) AS LATE_FEES,
  Format(Coalesce(lostfees.Sum_amountoutstanding, 0), 2) AS LOST_FEES,
  Format(Coalesce(otherfees.Sum_amountoutstanding, 0), 2) AS OTHER_FEES
FROM
  borrowers
  LEFT JOIN issues ON issues.borrowernumber = borrowers.borrowernumber
  LEFT JOIN (SELECT
      borrowers.guarantorid,
      Count(borrowers.borrowernumber) AS Count_borrowernumber
    FROM
      borrowers
    GROUP BY
      borrowers.guarantorid) guarantor ON borrowers.borrowernumber = guarantor.guarantorid
  LEFT JOIN (SELECT
      accountlines.borrowernumber,
      Sum(accountlines.amountoutstanding) AS Sum_amountoutstanding
    FROM
      accountlines
    WHERE
      accountlines.accounttype LIKE "L%"
    GROUP BY
      accountlines.borrowernumber) lostfees ON borrowers.borrowernumber = lostfees.borrowernumber
  LEFT JOIN (SELECT
      accountlines.borrowernumber,
      Sum(accountlines.amountoutstanding) AS Sum_amountoutstanding
    FROM
      accountlines
    WHERE
      accountlines.accounttype <> "L" AND
      accountlines.accounttype <> "LOSTI" AND
      accountlines.accounttype <> "LR" AND
      accountlines.accounttype <> 'F' AND
      accountlines.accounttype <> 'FU' AND
      accountlines.accounttype <> 'FINE'
    GROUP BY
      accountlines.borrowernumber) otherfees ON borrowers.borrowernumber = otherfees.borrowernumber
  LEFT JOIN (SELECT
      accountlines.borrowernumber,
      Sum(accountlines.amountoutstanding) AS Sum_amountoutstanding
    FROM
      accountlines
    GROUP BY
      accountlines.borrowernumber) totalfees ON borrowers.borrowernumber = totalfees.borrowernumber
  LEFT JOIN (SELECT
      accountlines.borrowernumber,
      Sum(accountlines.amountoutstanding) AS Sum_amountoutstanding
    FROM
      accountlines
    WHERE
      (accountlines.accounttype = 'F') OR
      (accountlines.accounttype = 'Fine') OR
      (accountlines.accounttype = 'FU')
    GROUP BY
      accountlines.borrowernumber) latefees ON borrowers.borrowernumber = latefees.borrowernumber
  LEFT JOIN reserves ON reserves.borrowernumber = borrowers.borrowernumber
WHERE
  borrowers.branchcode LIKE <<Choose your library|ZBRAN>> AND
  borrowers.dateexpiry <= CurDate() - INTERVAL 1095.75 DAY AND
  borrowers.categorycode <> "HOOPLA" AND
  borrowers.categorycode <> "ILL" AND
  borrowers.categorycode <> "INHOUSE" AND
  borrowers.categorycode <> "NEKLSTEST" AND
  borrowers.categorycode <> "STAFF" AND
  borrowers.categorycode <> "STATISTIC"
GROUP BY
  borrowers.borrowernumber,
  borrowers.branchcode,
  Coalesce(guarantor.Count_borrowernumber, 0),
  guarantor.Count_borrowernumber
HAVING
  (CURRENT_CKO_COUNT > 0) OR
  (CURRENT_REQUEST_COUNT > 0) OR
  (GUARANTEE_COUNT > 0) OR
  (TOTAL_FEES > 0)
ORDER BY
  borrowers.branchcode,
  borrowers.categorycode,
  borrowers.dateexpiry



